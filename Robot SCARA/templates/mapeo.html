<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Herramienta de Mapeo SCARA (Corregida)</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #0f172a; font-family: sans-serif; color: white; }
        #controls {
            position: absolute; top: 20px; left: 20px;
            background: rgba(17,24,39,0.9); padding: 20px;
            border-radius: 12px; border: 1px solid #374151;
        }
        h2 { color: #38bdf8; margin-top: 0; }
        button {
            background: #3b82f6; color: white; border: none;
            padding: 10px 20px; border-radius: 6px; font-weight: bold;
            cursor: pointer; font-size: 14px; margin-top: 10px; width: 100%;
        }
        button:hover { background: #2563eb; }
        button.reset { background: #ef4444; margin-top: 5px; }
        .info { font-size: 12px; color: #94a3b8; margin-bottom: 10px; }
        #debug { margin-top: 10px; font-family: monospace; color: #fbbf24; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script type="importmap">{ "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/" } }</script>
</head>
<body>

    <div id="controls">
        <h2>MAPEO DE L√çMITES (PLANO XY)</h2>
        <p class="info">1. Mueve el robot por todo el borde EXTERIOR.</p>
        <p class="info">2. La l√≠nea roja dibuja el contorno en el suelo.</p>
        <div id="point-count">Puntos: 0</div>
        <div id="debug">X: 0.00, Y: 0.00</div>
        <button onclick="exportPoints()">üíæ EXPORTAR L√çMITE</button>
        <button class="reset" onclick="resetTrail()">üóëÔ∏è BORRAR TRAZO</button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // 1. ESCENA
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0f172a);
        
        // C√ÅMARA TOP-DOWN (Vista de P√°jaro) para ver el plano XY
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(0, 100, 0); 
        camera.lookAt(0, 0, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        const controls = new OrbitControls(camera, renderer.domElement);

        // Grid en el plano XZ (Suelo)
        scene.add(new THREE.GridHelper(100, 20, 0x334155, 0x1e293b));
        scene.add(new THREE.AxesHelper(10)); // Rojo=X, Verde=Y, Azul=Z

        // 2. PUNTERO DEL ROBOT (Visualizaci√≥n simple)
        const pointerGeo = new THREE.SphereGeometry(1, 16, 16);
        const pointerMat = new THREE.MeshBasicMaterial({ color: 0xffff00 });
        const pointer = new THREE.Mesh(pointerGeo, pointerMat);
        scene.add(pointer);

        // 3. TRAZO (L√≠nea Roja en el Suelo)
        const MAX_POINTS = 5000;
        let pointsCount = 0;
        const trailGeo = new THREE.BufferGeometry();
        const trailPos = new Float32Array(MAX_POINTS * 3);
        trailGeo.setAttribute('position', new THREE.BufferAttribute(trailPos, 3));
        trailGeo.setDrawRange(0, 0);
        
        const trailMat = new THREE.LineBasicMaterial({ color: 0xf43f5e, linewidth: 3 });
        const trailLine = new THREE.Line(trailGeo, trailMat);
        scene.add(trailLine);

        window.recordedPoints = [];

        // 4. SOCKET
        const socket = io();
        socket.on('actualizar_gemelo', (data) => {
            if(!data || !data.coords || !data.coords.final) return;

            // OBTENER COORDENADAS (Asegurando que son n√∫meros)
            const x = parseFloat(data.coords.final.x);
            const y = parseFloat(data.coords.final.y);
            
            // DEBUG VISUAL
            document.getElementById('debug').innerText = `X: ${x.toFixed(2)}, Y: ${y.toFixed(2)}`;

            // Mover puntero visual (En ThreeJS, Y es arriba, as√≠ que mapeamos Y rob√≥tica a Z visual negativo)
            // Robot: X=Derecha, Y=Adelante, Z=Arriba
            // ThreeJS: X=Derecha, Y=Arriba, Z=Atr√°s
            // Mapeo para ver en suelo: X->X, Y->-Z
            
            pointer.position.set(x, 0.5, -y); 

            // L√ìGICA DE GRABACI√ìN
            if (pointsCount > 0) {
                const lastX = trailPos[(pointsCount-1)*3];
                const lastZ = trailPos[(pointsCount-1)*3 + 2]; // Usamos Z visual para Y del robot
                const dist = Math.sqrt((x-lastX)**2 + ((-y)-lastZ)**2);
                if (dist < 1.0) return; // Filtro: Solo guarda si se mueve 1cm
            }

            if (pointsCount < MAX_POINTS) {
                // Guardar para visualizaci√≥n en ThreeJS (X, 0, -Y)
                trailPos[pointsCount * 3] = x;
                trailPos[pointsCount * 3 + 1] = 0.1; // Pegado al piso
                trailPos[pointsCount * 3 + 2] = -y;

                // Guardar DATOS REALES para exportar [X, Y]
                window.recordedPoints.push([parseFloat(x.toFixed(2)), parseFloat(y.toFixed(2))]);

                pointsCount++;
                trailGeo.setDrawRange(0, pointsCount);
                trailGeo.attributes.position.needsUpdate = true;
                
                document.getElementById('point-count').innerText = `Puntos: ${pointsCount}`;
            }
        });

        // 5. FUNCIONES
        window.resetTrail = function() {
            pointsCount = 0;
            trailGeo.setDrawRange(0, 0);
            window.recordedPoints = [];
            document.getElementById('point-count').innerText = `Puntos: 0`;
        };

        window.exportPoints = function() {
            console.log("--- COPIA ESTO ---");
            console.log(JSON.stringify(window.recordedPoints));
            console.log("------------------");
            alert("Datos en Consola (F12). ¬°C√≥pialos y env√≠alos!");
        };

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>